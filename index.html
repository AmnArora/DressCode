<html>
  <head>
    <meta charset="utf-8">
    <title>DressCode</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" media="screen" title="no title">
    <link rel="stylesheet" href="assets/css/style.css" media="screen" title="no title">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="assets/libs/angular.min.js"></script>
    <script src="assets/libs/jquery.min.js"></script>
    <script src="assets/libs/angular-local-storage.min.js"></script>
    <script src="assets/libs/bootstrap.min.js"></script>
    <script src="app/login/loginController.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-animate.js"></script>
  </head>
  <body ng-app='dresscode'>
    <div class="container">
      <div ng-view></div>
    </div>
  </body>
  <script type="text/javascript">
  var app = angular.module('dresscode',['ngRoute','ngAnimate','LocalStorageModule']);
  app.config(['$routeProvider','localStorageServiceProvider', function($routeProvider,localStorageServiceProvider) {
    localStorageServiceProvider
    .setPrefix('dresscode');
    localStorageServiceProvider
    .setStorageType('sessionStorage');
     $routeProvider
     .when('/', {
        templateUrl: 'app/dresscode/dresscode.html',
        controller: 'loginController'
     })
     .when('/home', {
        templateUrl: 'app/dashboard/dashboard.html',
        controller:'cartController'
     })
     .when('/cart', {
        templateUrl: 'app/cart/cart.html',
        controller:'cart'
     })
     .when('/logout', {
       templateUrl: 'app/logout/logout.html',
       controller:'logout'
      })
     .otherwise({ redirectTo: '/' });
  }]);
  app.controller('loginController',['$scope','$location','$http','$rootScope','localStorageService',function($scope,$location,$http,$rootScope,localStorageService){
    $scope.loginCheck = function(){
      var email = $scope.email;
      var password = $scope.password ;
      $http.get('app/login/users.json')
      .then(function(response,users){
        users = response.data;
        angular.forEach(users,function(user,key){
            if(user.email == email && user.password==password){
              $rootScope.id = user.id;
              $rootScope.user = user;
              if(localStorageService.isSupported) {
                localStorageService.set('ActiveUser', user);
              }
              $location.path("/home");
            }
        });
      });
    };
  }]);
  app.controller('cartController',function($scope,$http,$rootScope,$location,localStorageService){
    if($rootScope.user){
      $scope.name = $rootScope.user.name;
    } else {
      if(localStorageService.get("ActiveUser")){
        $rootScope.user = localStorageService.get("ActiveUser");
        $scope.name = $rootScope.user.name;
        console.log(localStorageService.get("ActiveUser"));
      } else {
        $location.path("/");
      }

    }
    if(localStorageService.get("cartItems")){
      $rootScope.cart = localStorageService.get("cartItems");
      console.log(localStorageService.get("cartItems"));
    }else {
        $rootScope.cart = [];
    }
    var shuffleArray = function(array) {
        var m = array.length, t, i;
        while (m) {
          i = Math.floor(Math.random() * m--);
          t = array[m];
          array[m] = array[i];
          array[i] = t;
        }
        return array;
      }
    $scope.cart = $rootScope.cart;
    $http.get('app/products/products.json').success(function (response) {
      shuffleArray(response);
      $scope.products = response;
    });
    $scope.addToCart = function (product) {
      var found = false;
      $rootScope.cart.forEach(function (item) {
        if (item.id === product.id) {
          item.quantity++;
          found = true;
        }
      });
      if (!found) {
        $rootScope.cart.push(angular.extend({quantity: 1}, product));
      }
      if(localStorageService.isSupported) {
        localStorageService.set('cartItems', $rootScope.cart);
      }
      console.log($rootScope.cart);
    };
    $scope.setProduct = function(product){
      $scope.detail = product;
    };
  });
  app.controller('cart',function($scope,$http,$rootScope,$location,localStorageService){
    if($rootScope.user){
      $scope.name = $rootScope.user.name;
    } else {
      if(localStorageService.get("ActiveUser")){
        $rootScope.user = localStorageService.get("ActiveUser");
        $scope.name = $rootScope.user.name;
        console.log(localStorageService.get("ActiveUser"));
        } else {
          $location.path("/");
        }
    }
    if(localStorageService.get("cartItems")){
      $rootScope.cart = localStorageService.get("cartItems");
      console.log(localStorageService.get("cartItems"));
    }else {
        $rootScope.cart = [];
    }
    $scope.cart = $rootScope.cart;
    $scope.getCartPrice = function(){
      var total = 0;
      $scope.cart.forEach(function (product) {
        total += product.price * product.quantity;
        console.log(product.quantity);
      });
      return total;
    };
    $scope.removeFromCart = function (product) {
      var newCart = [];
      $rootScope.cart.forEach(function (item) {
        if (item.id != product.id) {
          newCart.push(item);
        }
      });
      $scope.cart = newCart;
      $rootScope.cart = newCart;
      if(localStorageService.isSupported) {
        localStorageService.set('cartItems', $rootScope.cart);
      }
      console.log($rootScope.cart);
    };
  });
  app.controller('logout',['$scope','$location','$http','$rootScope','localStorageService',function($scope,$location,$http,$rootScope,localStorageService){
    if(localStorageService.get("ActiveUser")){
      localStorageService.remove("ActiveUser");
    } else {
      $location.path("/");
    }
  }]);
  </script>
</html>
